<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KPHL Snow Forecast Comparison</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:#0a0e14; --panel:#0f1520; --border:#1e2d45;
      --accent:#2a9fd6; --accent2:#00e5ff; --warn:#f0b429;
      --dim:#3a4a5c; --text:#cdd6e0;
      --mono:'Share Tech Mono',monospace; --sans:'Barlow Condensed',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;padding-bottom:60px}

    header{background:var(--panel);border-bottom:1px solid var(--border);padding:16px 28px 12px;display:flex;align-items:flex-end;gap:20px;flex-wrap:wrap}
    h1{font-size:2rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--accent2);line-height:1}
    h1 span{color:var(--warn)}
    .hsub{font-size:.82rem;color:var(--dim);font-family:var(--mono);margin-bottom:2px}
    .hmeta{margin-left:auto;text-align:right}
    .hmeta .ts{font-family:var(--mono);font-size:.76rem;color:var(--dim)}

    .ctrl{display:flex;gap:10px;align-items:center;padding:11px 28px;background:#0c1119;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .ctrl label{font-size:.76rem;text-transform:uppercase;letter-spacing:.1em;color:var(--dim)}
    input[type=date],input[type=number]{background:var(--panel);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:.8rem;padding:5px 9px;border-radius:3px;outline:none}
    input:focus{border-color:var(--accent)}
    .btn{padding:6px 16px;background:var(--accent);color:#000;border:none;border-radius:3px;font-family:var(--sans);font-weight:700;font-size:.82rem;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:background .15s}
    .btn:hover{background:var(--accent2)} .btn:disabled{opacity:.4;cursor:not-allowed}
    .btng{background:transparent;border:1px solid var(--border);color:var(--dim)}
    .btng:hover{border-color:var(--accent);color:var(--accent);background:transparent}

    #sbar{padding:6px 28px;font-family:var(--mono);font-size:.71rem;min-height:28px;display:flex;gap:11px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--border);background:#0b1018}
    .si{display:flex;align-items:center;gap:5px;cursor:default}
    .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
    .dok{background:#4caf50} .dld{background:var(--warn);animation:bk 1s infinite}
    .der{background:#ef5350} .dmn{background:var(--dim)}
    @keyframes bk{0%,100%{opacity:1}50%{opacity:.2}}

    .tw{padding:16px 28px;overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:.84rem;min-width:700px}
    thead th{padding:5px 8px;text-align:center;font-family:var(--mono);font-size:.67rem;letter-spacing:.07em;text-transform:uppercase;color:var(--dim);border-bottom:2px solid var(--border);white-space:nowrap}
    thead th.thl{text-align:left;color:var(--text)}
    .thg{background:#0c1119;color:var(--accent);font-size:.64rem;padding:3px 8px;border-bottom:1px solid var(--border);letter-spacing:.1em}
    tr.gd td{padding:3px 10px;background:#0c1119;font-family:var(--mono);font-size:.62rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent);border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    tbody tr{border-bottom:1px solid #111c28;transition:background .1s}
    tbody tr:hover:not(.gd){background:rgba(42,159,214,.05)}
    tr.nhl{background:rgba(0,229,255,.035)} tr.nhl:hover{background:rgba(0,229,255,.08)}
    td{padding:7px 8px;text-align:center;font-family:var(--mono);font-size:.79rem;white-space:nowrap}
    .tds{text-align:left;font-family:var(--sans);font-weight:600;font-size:.87rem}
    .tdr{font-size:.68rem;color:var(--dim)}
    .tdt{font-weight:700;color:var(--accent2);border-left:1px solid var(--border)}
    .oor{color:#1e3040;font-size:.65rem}

    .sn{color:var(--dim)} .s0{color:#2a4050}
    .sT{color:#5b9ec9;font-size:.7rem} .s1{color:#9ecae1} .s2{color:#4292c6}
    .s3{color:#c8e6ff;background:#08519c33;border-radius:3px}
    .s4{color:#fff;background:#08519c88;border-radius:3px;font-weight:700}

    .badge{display:inline-block;padding:1px 5px;border-radius:2px;font-size:.65rem;font-family:var(--mono);margin-left:5px;vertical-align:middle}
    .bnws{background:#00e5ff12;color:var(--accent2);border:1px solid #00e5ff28}
    .bnbm{background:#00bcd412;color:#80deea;border:1px solid #00bcd428}
    .bgfs{background:#4caf5012;color:#81c784;border:1px solid #4caf5028}
    .bgef{background:#4caf5009;color:#a5d6a7;border:1px solid #4caf5018}
    .becm{background:#9c27b012;color:#ce93d8;border:1px solid #9c27b028}
    .bgem{background:#ff572212;color:#ff8a65;border:1px solid #ff572228}
    .bhrr{background:#ff980012;color:#ffb74d;border:1px solid #ff980028}
    .bnam{background:#e91e6312;color:#f48fb1;border:1px solid #e91e6328}
    .busr{background:#1e2d45;color:var(--dim);border:1px solid #1e2d45}

    td[contenteditable=true]{outline:none;cursor:text}
    td[contenteditable=true]:focus{background:rgba(42,159,214,.1);outline:1px solid var(--accent);border-radius:2px}

    .leg{display:flex;gap:14px;align-items:center;padding:0 28px 10px;flex-wrap:wrap;font-size:.71rem;color:var(--dim);font-family:var(--mono)}
    .leg span{display:flex;align-items:center;gap:4px}

    /* Debug panel */
    #dbg{margin:0 28px 20px;padding:12px;background:#0c1119;border:1px solid var(--border);border-radius:4px;display:none}
    #dbg h3{font-family:var(--mono);font-size:.72rem;color:var(--accent);margin-bottom:8px;letter-spacing:.1em;text-transform:uppercase}
    #dbgLog{font-family:var(--mono);font-size:.68rem;color:var(--dim);line-height:1.8;max-height:220px;overflow-y:auto}
    #dbgLog .ok{color:#4caf50} #dbgLog .er{color:#ef5350} #dbgLog .url{color:#5b9ec9}

    .notes{padding:0 28px 20px;font-size:.7rem;color:var(--dim);font-family:var(--mono);line-height:1.9}
    .notes a{color:var(--accent);text-decoration:none} .notes a:hover{text-decoration:underline}
    .notes strong{color:#6a8caa}

    #banner{padding:5px 28px;background:#0f1a10;border-bottom:1px solid #1a3020;font-family:var(--mono);font-size:.7rem;color:#66bb6a;display:none}
    #overlay{position:fixed;inset:0;background:rgba(10,14,20,.9);display:none;align-items:center;justify-content:center;z-index:100}
    .spb{font-family:var(--mono);font-size:.8rem;color:var(--accent2);text-align:center}
    .flake{font-size:2.4rem;display:block;margin-bottom:10px;animation:sp 1.4s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    #ssub{font-size:.67rem;color:var(--dim);margin-top:6px;min-height:1.2em}

    .emsg{text-align:center;padding:36px;color:var(--dim);font-family:var(--mono)}
    @media(max-width:600px){header,.ctrl,.tw,.leg,.notes,#dbg{padding-left:12px;padding-right:12px}}
  </style>
</head>
<body>

<div id="overlay">
  <div class="spb">
    <span class="flake">â„</span>
    <div id="smsg">Fetching forecast dataâ€¦</div>
    <div id="ssub"></div>
  </div>
</div>

<header>
  <div>
    <h1>K<span>PHL</span> Snow Forecast</h1>
    <div class="hsub">Philadelphia Intl Â· 39.8729Â°N 75.2437Â°W Â· Elev 36 ft</div>
  </div>
  <div class="hmeta">
    <div class="ts" id="clk">â€”</div>
    <div class="ts" style="color:var(--text);margin-top:2px">Model Comparison Dashboard</div>
  </div>
</header>

<div id="banner">âŸ³ Auto-loading current model dataâ€¦</div>

<div class="ctrl">
  <label>Event Start (UTC)</label>
  <input type="date" id="startDate"/>
  <label>6-hr Periods</label>
  <input type="number" id="numP" value="8" min="2" max="24" style="width:56px"/>
  <button class="btn" id="rbtn" onclick="fetchAll()">âŸ³ Refresh</button>
  <button class="btn btng" onclick="clearManual()">Clear Manual</button>
  <button class="btn btng" onclick="exportCSV()">â†“ CSV</button>
  <button class="btn btng" onclick="toggleDbg()" id="dbgBtn" style="border-color:#2a9fd6;color:#2a9fd6">ğŸ”§ Debug</button>
  <span id="lrt" style="font-family:var(--mono);font-size:.67rem;color:var(--dim);margin-left:4px"></span>
</div>

<div id="sbar"><span style="color:var(--dim);font-size:.7rem">Starting upâ€¦</span></div>

<div class="tw">
  <table>
    <thead id="th"></thead>
    <tbody id="tb"><tr><td colspan="20" class="emsg">Loadingâ€¦</td></tr></tbody>
  </table>
</div>

<div class="leg">
  <span><span class="dot dok"></span>Live</span>
  <span><span class="dot der"></span>Error (hover for details)</span>
  <span><span class="dot dmn"></span>Manual edit</span>
  <span style="color:var(--text);margin-left:4px">Snow (in):</span>
  <span class="s0">0.0</span><span class="sT">T</span><span class="s1">0.1â€“1.9</span>
  <span class="s2">2â€“4.9</span><span class="s3">5â€“9.9</span><span class="s4">10+</span>
  <span style="color:var(--dim);margin-left:4px">Â· Â· Â· = outside model range</span>
</div>

<!-- Debug panel â€” shows exact URLs called and raw errors -->
<div id="dbg">
  <h3>ğŸ”§ Debug Log â€” API Calls &amp; Responses</h3>
  <div id="dbgLog"><em style="color:var(--dim)">Click Refresh to populateâ€¦</em></div>
</div>

<div class="notes">
  <strong>Sources:</strong>
  NWS Official (<a href="https://api.weather.gov" target="_blank">api.weather.gov</a> gridded snowfallAmount mmâ†’in) Â·
  NBM/GFS/HRRR/NAM (<a href="https://open-meteo.com/en/docs/gfs-api" target="_blank">open-meteo /v1/forecast</a> with models= param) Â·
  GEFS (<a href="https://ensemble-api.open-meteo.com" target="_blank">ensemble-api.open-meteo.com /v1/ensemble</a>) Â·
  ECMWF (<a href="https://open-meteo.com/en/docs/ecmwf-api" target="_blank">open-meteo /v1/ecmwf</a>) Â·
  GEM (<a href="https://open-meteo.com/en/docs/gem-api" target="_blank">open-meteo /v1/gem</a>) Â·
  Click <strong>Debug</strong> to see exact API URLs and error messages.
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LAT=39.8729, LON=-75.2437;
const CM_IN=0.393701, MM_IN=0.0393701;

// Model forecast range limits (hours)
const RANGES={nws:Infinity,nbm:264,gfs:384,gefs:840,ecmwf:240,gem:240,hrrr:48,nam:60};

const SOURCES=[
  {id:'nws',  label:'NWS Official', badge:'NWS',  bc:'bnws', group:'Official',  fn:fetchNWS},
  {id:'nbm',  label:'NBM v4.3',     badge:'NBM',  bc:'bnbm', group:'Official',  fn:(s,n)=>fetchGfsEndpoint('ncep_nbm_conus', s,n,11)},
  {id:'gfs',  label:'GFS Seamless', badge:'GFS',  bc:'bgfs', group:'Global',    fn:(s,n)=>fetchForecast('gfs_seamless',s,n,16)},
  {id:'gefs', label:'GEFS Mean',    badge:'GEFS', bc:'bgef', group:'Global',    fn:fetchGEFS},
  {id:'ecmwf',label:'ECMWF IFS',   badge:'ECMWF',bc:'becm', group:'Global',    fn:fetchECMWF},
  {id:'gem',  label:'GEM Canadian', badge:'GEM',  bc:'bgem', group:'Global',    fn:fetchGEM},
  {id:'hrrr', label:'HRRR',         badge:'HRRR', bc:'bhrr', group:'Mesoscale', fn:(s,n)=>fetchGfsEndpoint('ncep_hrrr_conus', s,n,2)},
  {id:'nam',  label:'NAM Conus',    badge:'NAM',  bc:'bnam', group:'Mesoscale', fn:(s,n)=>fetchGfsEndpoint('ncep_nam_conus',  s,n,3)},
];

let S={start:null,numP:8,data:{},status:{},fetchedAt:null};
let dbgOpen=false;
const dbgLines=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('startDate').value=new Date().toISOString().slice(0,10);
  setInterval(tickClk,1000); tickClk();
  const b=document.getElementById('banner');
  b.style.display='block';
  setTimeout(()=>{b.style.display='none'; fetchAll();},350);
});
function tickClk(){
  document.getElementById('clk').textContent=
    new Date().toUTCString().replace(/^.*?, /,'').replace(' GMT','  UTC');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORCHESTRATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAll(){
  const dv=document.getElementById('startDate').value;
  const np=Math.max(2,Math.min(24,parseInt(document.getElementById('numP').value)||8));
  if(!dv){alert('Select a start date.');return;}

  S.start=new Date(dv+'T00:00:00Z');
  S.numP=np; S.data={}; S.status={};
  S.fetchedAt=new Date();
  SOURCES.forEach(s=>S.status[s.id]='loading');
  dbgLines.length=0; renderDbg();

  const btn=document.getElementById('rbtn');
  btn.disabled=true;
  showOv('Contacting data sourcesâ€¦');
  renderSbar(); renderTable();

  await Promise.allSettled(SOURCES.map(async src=>{
    setSub('Fetching '+src.label+'â€¦');
    try{
      S.data[src.id]=await src.fn(S.start,np);
      S.status[src.id]='ok';
      dbgLog('âœ“ '+src.label,'ok');
    }catch(e){
      console.warn('['+src.id+']',e.message);
      S.data[src.id]={runTime:null,periods:Array(np).fill(null),err:e.message};
      S.status[src.id]='error';
      dbgLog('âœ— '+src.label+': '+e.message,'er');
    }
    renderSbar(); renderDbg();
  }));

  hideOv(); btn.disabled=false; renderTable();
  document.getElementById('lrt').textContent=
    'Refreshed '+new Date().toUTCString().replace(/^.*?, /,'').replace(' GMT','z').slice(0,9);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NWS OFFICIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchNWS(startDate,numP){
  const H={'User-Agent':'KPHL-Snow-Dashboard/5.0 (howpomp.github.io/KPHL_Snow)'};
  const pt=await getJ('https://api.weather.gov/points/'+LAT+','+LON,H);
  const gridUrl=pt.properties.forecastGridData;
  dbgLog('NWS grid URL: '+gridUrl,'url');
  const gd=await getJ(gridUrl,H);
  const p=gd.properties;
  const rt=p.updateTime?fmtR(new Date(p.updateTime)):'NWS Current';

  const vals=(p.snowfallAmount?.values?.length ? p.snowfallAmount.values
            : p.snowfall?.values?.length       ? p.snowfall.values : []);
  dbgLog('NWS snowfallAmount entries: '+vals.length,'ok');

  const hrMap={};
  vals.forEach(({validTime,value})=>{
    if(value==null)return;
    const[ts,dur]=validTime.split('/');
    const base=new Date(ts), hrs=parseDur(dur);
    for(let h=0;h<hrs;h++) hrMap[uhk(new Date(base.getTime()+h*3600000))]=value;
  });
  return{runTime:rt,periods:buildP(startDate,numP,hrMap,MM_IN)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OPEN-METEO /v1/forecast  (GFS, NBM, HRRR, NAM)
//  Uses forecast_hours to avoid start_date/end_date conflicts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchForecast(model,startDate,numP,maxDays){
  // Calculate how many hours ahead the event end is from NOW
  const nowMs=Date.now();
  const eventEndMs=startDate.getTime()+numP*6*3600000;
  const hoursNeeded=Math.ceil((eventEndMs-nowMs)/3600000)+6; // +6 buffer
  const forecastHours=Math.max(24,Math.min(maxDays*24, hoursNeeded));

  // Also need past_hours if event start is in the past
  const hoursBack=Math.max(0,Math.ceil((nowMs-startDate.getTime())/3600000));
  const pastHours=Math.min(hoursBack+1,168); // max 7 days back

  const url='https://api.open-meteo.com/v1/forecast'
    +'?latitude='+LAT+'&longitude='+LON
    +'&hourly=snowfall'
    +'&models='+model
    +'&forecast_hours='+forecastHours
    +(pastHours>0?'&past_hours='+pastHours:'')
    +'&timezone=UTC';

  dbgLog(model+' â†’ '+url.replace('https://api.open-meteo.com','â€¦'),'url');
  const j=await getJ(url);
  if(j.error)throw new Error(j.reason||'Open-Meteo error for '+model);

  const times=j.hourly?.time||[];
  const snow=j.hourly?.snowfall||[];
  if(!times.length)throw new Error('No data: '+model);
  dbgLog(model+' â†’ '+times.length+' hours returned, non-null snow: '+snow.filter(v=>v!=null).length,'ok');

  const hrMap={};
  times.forEach((t,i)=>{if(snow[i]!=null)hrMap[t.slice(0,13)]=snow[i];});
  return{runTime:fmtR(new Date(times[0])),periods:buildP(startDate,numP,hrMap,CM_IN)};
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OPEN-METEO /v1/gfs  â€” NBM, HRRR, NAM
//  These models require the dedicated /v1/gfs endpoint
//  with models= param (not /v1/forecast which rejects them)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchGfsEndpoint(model,startDate,numP,maxDays){
  const s=startDate.toISOString().slice(0,10);
  const e=new Date(startDate.getTime()+numP*6*3600000+86400000).toISOString().slice(0,10);
  const url='https://api.open-meteo.com/v1/gfs'
    +'?latitude='+LAT+'&longitude='+LON
    +'&hourly=snowfall'
    +'&models='+model
    +'&start_date='+s+'&end_date='+e
    +'&timezone=UTC';
  // ncep_ prefix required: ncep_hrrr_conus, ncep_nam_conus, ncep_nbm_conus
  // NOTE: forecast_days removed â€” mutually exclusive with start_date/end_date
  dbgLog(model+' /v1/gfs â†’ '+url.replace('https://api.open-meteo.com','â€¦'),'url');
  const j=await getJ(url);
  if(j.error)throw new Error(j.reason||'Open-Meteo /v1/gfs error: '+model);
  const times=j.hourly?.time||[];
  const snow=j.hourly?.snowfall||[];
  if(!times.length)throw new Error('No data from /v1/gfs: '+model);
  dbgLog(model+' â†’ '+times.length+' hrs, non-null: '+snow.filter(v=>v!=null).length,'ok');
  const hrMap={};
  times.forEach((t,i)=>{if(snow[i]!=null)hrMap[t.slice(0,13)]=snow[i];});
  return{runTime:fmtR(new Date(times[0])),periods:buildP(startDate,numP,hrMap,CM_IN)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEFS ENSEMBLE MEAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchGEFS(startDate,numP){
  const s=startDate.toISOString().slice(0,10);
  const e=new Date(startDate.getTime()+numP*6*3600000+86400000).toISOString().slice(0,10);
  const url='https://ensemble-api.open-meteo.com/v1/ensemble'
    +'?latitude='+LAT+'&longitude='+LON
    +'&hourly=snowfall&models=gfs_seamless'
    +'&start_date='+s+'&end_date='+e+'&timezone=UTC';
  dbgLog('GEFS â†’ '+url.replace('https://ensemble-api.open-meteo.com','â€¦'),'url');
  const j=await getJ(url);
  if(j.error)throw new Error(j.reason||'GEFS error');
  const times=j.hourly?.time||[];
  const mks=Object.keys(j.hourly||{}).filter(k=>k.startsWith('snowfall'));
  if(!mks.length)throw new Error('No GEFS members returned');
  dbgLog('GEFS â†’ '+mks.length+' members, '+times.length+' hours','ok');
  const hrMap={};
  times.forEach((t,i)=>{
    let sum=0,cnt=0;
    mks.forEach(k=>{const v=j.hourly[k][i];if(v!=null){sum+=v;cnt++;}});
    if(cnt>0)hrMap[t.slice(0,13)]=sum/cnt;
  });
  return{runTime:'GEFS '+mks.length+'-mbr mean',periods:buildP(startDate,numP,hrMap,CM_IN)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ECMWF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchECMWF(startDate,numP){
  const s=startDate.toISOString().slice(0,10);
  const e=new Date(startDate.getTime()+numP*6*3600000+86400000).toISOString().slice(0,10);
  const url='https://api.open-meteo.com/v1/ecmwf'
    +'?latitude='+LAT+'&longitude='+LON
    +'&hourly=snowfall&start_date='+s+'&end_date='+e+'&timezone=UTC';
  dbgLog('ECMWF â†’ '+url.replace('https://api.open-meteo.com','â€¦'),'url');
  const j=await getJ(url);
  if(j.error)throw new Error(j.reason||'ECMWF error');
  const times=j.hourly?.time||[];
  const snow=j.hourly?.snowfall||[];
  if(!times.length)throw new Error('No ECMWF data');
  dbgLog('ECMWF â†’ '+times.length+' hours','ok');
  const hrMap={};
  times.forEach((t,i)=>{if(snow[i]!=null)hrMap[t.slice(0,13)]=snow[i];});
  return{runTime:'ECMWF IFS 9km',periods:buildP(startDate,numP,hrMap,CM_IN)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEM Canadian
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchGEM(startDate,numP){
  const s=startDate.toISOString().slice(0,10);
  const e=new Date(startDate.getTime()+numP*6*3600000+86400000).toISOString().slice(0,10);
  const url='https://api.open-meteo.com/v1/gem'
    +'?latitude='+LAT+'&longitude='+LON
    +'&hourly=snowfall&models=gem_seamless'
    +'&start_date='+s+'&end_date='+e+'&timezone=UTC';
  dbgLog('GEM â†’ '+url.replace('https://api.open-meteo.com','â€¦'),'url');
  const j=await getJ(url);
  if(j.error)throw new Error(j.reason||'GEM error');
  const times=j.hourly?.time||[];
  const snow=j.hourly?.snowfall||[];
  if(!times.length)throw new Error('No GEM data');
  dbgLog('GEM â†’ '+times.length+' hours','ok');
  const hrMap={};
  times.forEach((t,i)=>{if(snow[i]!=null)hrMap[t.slice(0,13)]=snow[i];});
  return{runTime:fmtR(new Date(times[0])),periods:buildP(startDate,numP,hrMap,CM_IN)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getJ(url,headers={}){
  let r;
  try{r=await fetch(url,{headers:{Accept:'application/json',...headers}});}
  catch(e){throw new Error('Network: '+e.message);}
  const txt=await r.text();
  let j;
  try{j=JSON.parse(txt);}catch(e){
    // Log the raw response for debugging
    dbgLog('Bad JSON (first 200 chars): '+txt.slice(0,200),'er');
    throw new Error('Non-JSON response from: '+url.slice(0,60));
  }
  if(!r.ok)throw new Error(j?.reason||j?.detail||j?.title||'HTTP '+r.status+' from '+url.slice(0,50));
  return j;
}

function buildP(startDate,numP,hrMap,factor){
  return Array.from({length:numP},(_,p)=>{
    const t0=new Date(startDate.getTime()+p*6*3600000);
    let sum=0,any=false;
    for(let h=0;h<6;h++){
      const v=hrMap[uhk(new Date(t0.getTime()+h*3600000))];
      if(v!=null){sum+=v;any=true;}
    }
    return any?+((sum*factor).toFixed(2)):null;
  });
}

function inRange(id,pStart){
  const maxH=RANGES[id]??Infinity;
  return(pStart.getTime()-S.fetchedAt.getTime())/3600000<maxH;
}
function uhk(d){return d.toISOString().slice(0,13);}
function parseDur(s){if(!s)return 1;const m=s.match(/PT(\d+)H/);return m?+m[1]:1;}
function fmtR(d){
  if(!d||isNaN(d))return'â€”';
  const mo=d.toLocaleString('en-US',{month:'short',timeZone:'UTC'});
  return mo+' '+d.getUTCDate()+' '+String(d.getUTCHours()).padStart(2,'0')+'z';
}
function fmtPH(d){
  const mo=d.toLocaleString('en-US',{month:'short',timeZone:'UTC'});
  const h0=String(d.getUTCHours()).padStart(2,'0');
  const h1=String(d.getUTCHours()+6).padStart(2,'0');
  return mo+' '+d.getUTCDate()+'<br/>'+h0+'zâ€“'+h1+'z';
}
function fmtV(v){
  if(v===null||v===undefined)return'â€”';
  if(v<0.005)return'0.0'; if(v<0.05)return'T';
  return v.toFixed(1);
}
function vCls(v){
  if(v===null||v===undefined)return'sn';
  if(v<0.005)return's0'; if(v<0.05)return'sT';
  if(v<2)return's1'; if(v<5)return's2'; if(v<10)return's3'; return's4';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEBUG LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dbgLog(msg,cls){
  dbgLines.push({msg,cls:cls||''});
  if(dbgOpen)renderDbg();
}
function renderDbg(){
  const el=document.getElementById('dbgLog');
  if(!el)return;
  if(!dbgLines.length){el.innerHTML='<em style="color:var(--dim)">No log entries yet.</em>';return;}
  el.innerHTML=dbgLines.map(l=>'<div class="'+l.cls+'">'+escHtml(l.msg)+'</div>').join('');
  el.scrollTop=el.scrollHeight;
}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toggleDbg(){
  dbgOpen=!dbgOpen;
  document.getElementById('dbg').style.display=dbgOpen?'block':'none';
  document.getElementById('dbgBtn').textContent=dbgOpen?'Hide Debug':'Debug';
  if(dbgOpen)renderDbg();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable(){
  if(!S.start)return;
  const th=document.getElementById('th');
  th.innerHTML='';
  const gr=document.createElement('tr');
  gr.innerHTML='<th class="thg thl" colspan="2">Source / Run</th>'
    +'<th class="thg" colspan="'+S.numP+'">6-Hourly Snowfall Accumulation (inches)</th>'
    +'<th class="thg">Storm Total</th>';
  th.appendChild(gr);
  const hr=document.createElement('tr');
  let hh='<th class="thl">Model</th><th>Run Init</th>';
  for(let p=0;p<S.numP;p++)
    hh+='<th>'+fmtPH(new Date(S.start.getTime()+p*6*3600000))+'</th>';
  hh+='<th>Total</th>';
  hr.innerHTML=hh; th.appendChild(hr);

  const tb=document.getElementById('tb');
  tb.innerHTML='';
  let lastG=null;
  SOURCES.forEach(src=>{
    if(src.group!==lastG){
      const dtr=document.createElement('tr'); dtr.className='gd';
      dtr.innerHTML='<td colspan="'+(S.numP+3)+'">'+src.group+' Models</td>';
      tb.appendChild(dtr); lastG=src.group;
    }
    const d=S.data[src.id],st=S.status[src.id]||'manual';
    const tr=document.createElement('tr');
    if(src.id==='nws')tr.className='nhl';
    const rl=d?(d.runTime||'â€”'):(st==='loading'?'â€¦':'â€”');
    const tip=(st==='error'&&d?.err)?' title="'+d.err.replace(/"/g,"'")+'"':'';

    let html='<td class="tds"'+tip+'>'+src.label
      +'<span class="badge '+src.bc+'">'+src.badge+'</span></td>'
      +'<td class="tdr">'+rl+'</td>';
    let total=0,has=false;
    for(let p=0;p<S.numP;p++){
      const pS=new Date(S.start.getTime()+p*6*3600000);
      if(!inRange(src.id,pS)){
        html+='<td class="oor" title="Outside '+src.id.toUpperCase()+' range">Â· Â· Â·</td>';
      } else {
        const v=d?d.periods[p]:null;
        html+='<td id="'+src.id+'-p'+p+'" class="'+vCls(v)+'" contenteditable="true"'
          +' data-src="'+src.id+'" data-p="'+p+'" oninput="onEdit(this)"'
          +' title="'+pS.toUTCString()+'">'+fmtV(v)+'</td>';
        if(v!==null){total+=v;has=true;}
      }
    }
    html+='<td class="tdt '+vCls(has?total:null)+'" id="'+src.id+'-tot">'+(has?total.toFixed(1):'â€”')+'</td>';
    tr.innerHTML=html; tb.appendChild(tr);
  });

  // Manual row
  const mtr=document.createElement('tr');
  const md=S.data['manual'];
  let mh='<td class="tds" style="opacity:.55">Manual Entry<span class="badge busr">USER</span></td>'
    +'<td class="tdr" style="opacity:.35">â€”</td>';
  let mt=0,mHas=false;
  for(let p=0;p<S.numP;p++){
    const v=md?.periods[p]??null;
    mh+='<td id="manual-p'+p+'" class="'+vCls(v)+'" contenteditable="true"'
      +' data-src="manual" data-p="'+p+'" oninput="onEdit(this)">'+fmtV(v)+'</td>';
    if(v!==null){mt+=v;mHas=true;}
  }
  mh+='<td class="tdt '+vCls(mHas?mt:null)+'" id="manual-tot">'+(mHas?mt.toFixed(1):'â€”')+'</td>';
  mtr.innerHTML=mh; tb.appendChild(mtr);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CELL EDIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onEdit(td){
  const src=td.dataset.src,p=+td.dataset.p;
  const raw=td.textContent.trim();
  if(!S.data[src])S.data[src]={runTime:null,periods:Array(S.numP).fill(null)};
  let v=null;
  if(/^[Tt]$/.test(raw))v=0.02;
  else if(!raw||/^[â€”\-]$/.test(raw))v=null;
  else{v=parseFloat(raw);if(isNaN(v))v=null;}
  S.data[src].periods[p]=v;
  if(src!=='manual')S.status[src]='manual';
  td.className=vCls(v); recalcTot(src);
}
function recalcTot(src){
  const d=S.data[src]; if(!d)return;
  let t=0,has=false;
  d.periods.forEach(v=>{if(v!==null){t+=v;has=true;}});
  const el=document.getElementById(src+'-tot');
  if(el){el.textContent=has?t.toFixed(1):'â€”';el.className='tdt '+vCls(has?t:null);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSbar(){
  document.getElementById('sbar').innerHTML=SOURCES.map(src=>{
    const st=S.status[src.id]||'manual';
    const dc={ok:'dok',loading:'dld',error:'der',manual:'dmn'}[st]||'dmn';
    const lbl={ok:'Live',loading:'â€¦',error:'Error',manual:'Manual'}[st]||'â€”';
    const tip=(st==='error'&&S.data[src.id]?.err)
      ?' title="'+S.data[src.id].err.replace(/"/g,"'")+'"':'';
    return'<span class="si"'+tip+'><span class="dot '+dc+'"></span>'+src.label+': '+lbl+'</span>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERLAY / CLEAR / CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showOv(m){document.getElementById('smsg').textContent=m;document.getElementById('ssub').textContent='';document.getElementById('overlay').style.display='flex';}
function setSub(t){document.getElementById('ssub').textContent=t;}
function hideOv(){document.getElementById('overlay').style.display='none';}

function clearManual(){
  S.data['manual']={runTime:null,periods:Array(S.numP).fill(null)};
  for(let p=0;p<S.numP;p++){
    const el=document.getElementById('manual-p'+p);
    if(el){el.textContent='â€”';el.className='sn';}
  }
  const tot=document.getElementById('manual-tot');
  if(tot){tot.textContent='â€”';tot.className='tdt sn';}
}

function exportCSV(){
  if(!S.start){alert('No data yet.');return;}
  const hdrs=['Source','Run Init'];
  for(let p=0;p<S.numP;p++)
    hdrs.push(new Date(S.start.getTime()+p*6*3600000).toISOString().slice(0,13)+'z');
  hdrs.push('Storm Total');
  const allSrc=[...SOURCES,{id:'manual',label:'Manual Entry'}];
  const rows=[hdrs,...allSrc.map(src=>{
    const d=S.data[src.id];
    const row=[src.label,d?.runTime||''];
    let tot=0,has=false;
    for(let p=0;p<S.numP;p++){
      const v=d?.periods[p]??null;
      row.push(v===null?'':fmtV(v));
      if(v!==null){tot+=v;has=true;}
    }
    row.push(has?tot.toFixed(1):'');
    return row;
  })];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=Object.assign(document.createElement('a'),{
    href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
    download:'KPHL_snow_'+S.start.toISOString().slice(0,10)+'.csv'
  });
  a.click();
}
</script>
</body>
</html>
